<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.62" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://vuepress-theme-hope-docs-demo.netlify.app/zh/page/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6Kafka/Kafka.html"><meta property="og:site_name" content="JavaYoung"><meta property="og:title" content="Kafka"><meta property="og:description" content="消息中间件"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-05-20T11:00:13.000Z"><meta property="article:author" content="Young"><meta property="article:modified_time" content="2023-05-20T11:00:13.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Kafka","image":[""],"dateModified":"2023-05-20T11:00:13.000Z","author":[{"@type":"Person","name":"Young","url":"https://github.com/yangluheng"}]}</script><title>Kafka | JavaYoung</title><meta name="description" content="消息中间件">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-f06d6d01.css" as="style"><link rel="stylesheet" href="/assets/style-f06d6d01.css">
    <link rel="modulepreload" href="/assets/app-e5b0ad63.js"><link rel="modulepreload" href="/assets/Kafka.html-dbbba11a.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="modulepreload" href="/assets/Kafka.html-1083c6f4.js"><link rel="prefetch" href="/assets/index.html-8a4472be.js" as="script"><link rel="prefetch" href="/assets/slides.html-10888eff.js" as="script"><link rel="prefetch" href="/assets/index.html-f836477e.js" as="script"><link rel="prefetch" href="/assets/disable.html-796098cc.js" as="script"><link rel="prefetch" href="/assets/encrypt.html-77031c94.js" as="script"><link rel="prefetch" href="/assets/markdown.html-e3867a1d.js" as="script"><link rel="prefetch" href="/assets/page.html-8632525d.js" as="script"><link rel="prefetch" href="/assets/index.html-a163a7d5.js" as="script"><link rel="prefetch" href="/assets/index.html-e96c965e.js" as="script"><link rel="prefetch" href="/assets/index.html-3cbd65da.js" as="script"><link rel="prefetch" href="/assets/slides.html-e3677c12.js" as="script"><link rel="prefetch" href="/assets/index.html-8b4e8790.js" as="script"><link rel="prefetch" href="/assets/baz.html-823505f3.js" as="script"><link rel="prefetch" href="/assets/index.html-91e62cb1.js" as="script"><link rel="prefetch" href="/assets/ray.html-ef508b28.js" as="script"><link rel="prefetch" href="/assets/JVM.html-f40c4aed.js" as="script"><link rel="prefetch" href="/assets/Java基础.html-5df524cb.js" as="script"><link rel="prefetch" href="/assets/Java高级框架.html-dab53e0f.js" as="script"><link rel="prefetch" href="/assets/Kafka.html-6159f1dd.js" as="script"><link rel="prefetch" href="/assets/Linux常用命令.html-2e85e51f.js" as="script"><link rel="prefetch" href="/assets/操作系统.html-85593a49.js" as="script"><link rel="prefetch" href="/assets/Docker.html-8fd364e8.js" as="script"><link rel="prefetch" href="/assets/Spring Cloud.html-a8768d8b.js" as="script"><link rel="prefetch" href="/assets/ZooKeeper.html-56138991.js" as="script"><link rel="prefetch" href="/assets/场景问题 .html-db4fe8e5.js" as="script"><link rel="prefetch" href="/assets/HTTP.html-f1727d11.js" as="script"><link rel="prefetch" href="/assets/HTTP2.html-9fbbf7e4.js" as="script"><link rel="prefetch" href="/assets/HTTP3.html-89f1a622.js" as="script"><link rel="prefetch" href="/assets/计算机网络.html-b5820b30.js" as="script"><link rel="prefetch" href="/assets/ElasticSearch.html-7497a58b.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-a6709667.js" as="script"><link rel="prefetch" href="/assets/Redis.html-b59c5eb1.js" as="script"><link rel="prefetch" href="/assets/多线程和高并发.html-54133ada.js" as="script"><link rel="prefetch" href="/assets/面试.html-af84ceb8.js" as="script"><link rel="prefetch" href="/assets/来看头条.html-35cd8163.js" as="script"><link rel="prefetch" href="/assets/项目中常用技术一：MD5.html-d19adeb6.js" as="script"><link rel="prefetch" href="/assets/index.html-97c11b15.js" as="script"><link rel="prefetch" href="/assets/disable.html-84c2de70.js" as="script"><link rel="prefetch" href="/assets/encrypt.html-d6fdd0b4.js" as="script"><link rel="prefetch" href="/assets/markdown.html-911d816d.js" as="script"><link rel="prefetch" href="/assets/page.html-7fa3b537.js" as="script"><link rel="prefetch" href="/assets/index.html-8d7a7373.js" as="script"><link rel="prefetch" href="/assets/index.html-dd410593.js" as="script"><link rel="prefetch" href="/assets/index.html-f158004a.js" as="script"><link rel="prefetch" href="/assets/baz.html-806dd77f.js" as="script"><link rel="prefetch" href="/assets/index.html-6af6f1e8.js" as="script"><link rel="prefetch" href="/assets/ray.html-3d8f8307.js" as="script"><link rel="prefetch" href="/assets/JVM.html-bc666f42.js" as="script"><link rel="prefetch" href="/assets/Java基础.html-04ec0c08.js" as="script"><link rel="prefetch" href="/assets/Java高级框架.html-eb9bd4cc.js" as="script"><link rel="prefetch" href="/assets/Linux常用命令.html-000bb6f6.js" as="script"><link rel="prefetch" href="/assets/场景问题 .html-14309b1f.js" as="script"><link rel="prefetch" href="/assets/多线程和高并发.html-58f28bea.js" as="script"><link rel="prefetch" href="/assets/Docker.html-d1ac9001.js" as="script"><link rel="prefetch" href="/assets/Spring Cloud.html-327a34df.js" as="script"><link rel="prefetch" href="/assets/ZooKeeper.html-c604f9ed.js" as="script"><link rel="prefetch" href="/assets/操作系统.html-72b053b3.js" as="script"><link rel="prefetch" href="/assets/ElasticSearch.html-5820f046.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-5f9455c3.js" as="script"><link rel="prefetch" href="/assets/Redis.html-0dbc301e.js" as="script"><link rel="prefetch" href="/assets/HTTP.html-0992ad03.js" as="script"><link rel="prefetch" href="/assets/HTTP2.html-c1ec6d2c.js" as="script"><link rel="prefetch" href="/assets/计算机网络.html-2c725cfe.js" as="script"><link rel="prefetch" href="/assets/面试.html-1e42dadc.js" as="script"><link rel="prefetch" href="/assets/来看头条.html-a5e58da1.js" as="script"><link rel="prefetch" href="/assets/404.html-b6ae923e.js" as="script"><link rel="prefetch" href="/assets/index.html-1926b876.js" as="script"><link rel="prefetch" href="/assets/index.html-74061171.js" as="script"><link rel="prefetch" href="/assets/index.html-84b1e140.js" as="script"><link rel="prefetch" href="/assets/index.html-d4e34304.js" as="script"><link rel="prefetch" href="/assets/index.html-73d5bbec.js" as="script"><link rel="prefetch" href="/assets/index.html-354e6125.js" as="script"><link rel="prefetch" href="/assets/index.html-3520a6b9.js" as="script"><link rel="prefetch" href="/assets/index.html-17389d84.js" as="script"><link rel="prefetch" href="/assets/index.html-1fe91c12.js" as="script"><link rel="prefetch" href="/assets/index.html-dc3cdadb.js" as="script"><link rel="prefetch" href="/assets/index.html-d831f2a5.js" as="script"><link rel="prefetch" href="/assets/index.html-5db0b896.js" as="script"><link rel="prefetch" href="/assets/index.html-02dafaa7.js" as="script"><link rel="prefetch" href="/assets/index.html-65efbca6.js" as="script"><link rel="prefetch" href="/assets/index.html-427b60fc.js" as="script"><link rel="prefetch" href="/assets/index.html-35ad0756.js" as="script"><link rel="prefetch" href="/assets/index.html-25a6738a.js" as="script"><link rel="prefetch" href="/assets/index.html-071b3539.js" as="script"><link rel="prefetch" href="/assets/index.html-69ddf92e.js" as="script"><link rel="prefetch" href="/assets/index.html-f7efc390.js" as="script"><link rel="prefetch" href="/assets/index.html-d7596311.js" as="script"><link rel="prefetch" href="/assets/index.html-c3111431.js" as="script"><link rel="prefetch" href="/assets/index.html-4ac547fd.js" as="script"><link rel="prefetch" href="/assets/index.html-3e497cb3.js" as="script"><link rel="prefetch" href="/assets/index.html-7758b2b3.js" as="script"><link rel="prefetch" href="/assets/index.html-fc32f52d.js" as="script"><link rel="prefetch" href="/assets/index.html-06f6a95d.js" as="script"><link rel="prefetch" href="/assets/slides.html-2f904361.js" as="script"><link rel="prefetch" href="/assets/index.html-c38e83a2.js" as="script"><link rel="prefetch" href="/assets/disable.html-6af26208.js" as="script"><link rel="prefetch" href="/assets/encrypt.html-c748bf7f.js" as="script"><link rel="prefetch" href="/assets/markdown.html-0501997a.js" as="script"><link rel="prefetch" href="/assets/page.html-ced7aecd.js" as="script"><link rel="prefetch" href="/assets/index.html-177ab39c.js" as="script"><link rel="prefetch" href="/assets/index.html-e71113bf.js" as="script"><link rel="prefetch" href="/assets/index.html-cd6d4191.js" as="script"><link rel="prefetch" href="/assets/slides.html-60d54348.js" as="script"><link rel="prefetch" href="/assets/index.html-17128b84.js" as="script"><link rel="prefetch" href="/assets/baz.html-06c05fd6.js" as="script"><link rel="prefetch" href="/assets/index.html-e6414d52.js" as="script"><link rel="prefetch" href="/assets/ray.html-74b84bac.js" as="script"><link rel="prefetch" href="/assets/JVM.html-a2abf0f2.js" as="script"><link rel="prefetch" href="/assets/Java基础.html-86616cd7.js" as="script"><link rel="prefetch" href="/assets/Java高级框架.html-ad0d093a.js" as="script"><link rel="prefetch" href="/assets/Kafka.html-d36323d1.js" as="script"><link rel="prefetch" href="/assets/Linux常用命令.html-de86151d.js" as="script"><link rel="prefetch" href="/assets/操作系统.html-991214d0.js" as="script"><link rel="prefetch" href="/assets/Docker.html-680f94c4.js" as="script"><link rel="prefetch" href="/assets/Spring Cloud.html-9d3f7adc.js" as="script"><link rel="prefetch" href="/assets/ZooKeeper.html-00c41d46.js" as="script"><link rel="prefetch" href="/assets/场景问题 .html-fb112be9.js" as="script"><link rel="prefetch" href="/assets/HTTP.html-6caa167a.js" as="script"><link rel="prefetch" href="/assets/HTTP2.html-707a7d7d.js" as="script"><link rel="prefetch" href="/assets/HTTP3.html-fee5c4f3.js" as="script"><link rel="prefetch" href="/assets/计算机网络.html-a09009b3.js" as="script"><link rel="prefetch" href="/assets/ElasticSearch.html-924dfb6b.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-31199686.js" as="script"><link rel="prefetch" href="/assets/Redis.html-8d34cb57.js" as="script"><link rel="prefetch" href="/assets/多线程和高并发.html-53e7d412.js" as="script"><link rel="prefetch" href="/assets/面试.html-348f43e7.js" as="script"><link rel="prefetch" href="/assets/来看头条.html-ec760d57.js" as="script"><link rel="prefetch" href="/assets/项目中常用技术一：MD5.html-00ab5db1.js" as="script"><link rel="prefetch" href="/assets/index.html-ec7af5b7.js" as="script"><link rel="prefetch" href="/assets/disable.html-a09ec8cb.js" as="script"><link rel="prefetch" href="/assets/encrypt.html-4b472366.js" as="script"><link rel="prefetch" href="/assets/markdown.html-15af0b80.js" as="script"><link rel="prefetch" href="/assets/page.html-581f93fd.js" as="script"><link rel="prefetch" href="/assets/index.html-201f5882.js" as="script"><link rel="prefetch" href="/assets/index.html-28641f72.js" as="script"><link rel="prefetch" href="/assets/index.html-e83e8326.js" as="script"><link rel="prefetch" href="/assets/baz.html-dc5e38e5.js" as="script"><link rel="prefetch" href="/assets/index.html-b133cc0c.js" as="script"><link rel="prefetch" href="/assets/ray.html-4eb2e8b2.js" as="script"><link rel="prefetch" href="/assets/JVM.html-735c0a22.js" as="script"><link rel="prefetch" href="/assets/Java基础.html-c19cc48d.js" as="script"><link rel="prefetch" href="/assets/Java高级框架.html-6ec0d248.js" as="script"><link rel="prefetch" href="/assets/Linux常用命令.html-90b798a3.js" as="script"><link rel="prefetch" href="/assets/场景问题 .html-c3d8807b.js" as="script"><link rel="prefetch" href="/assets/多线程和高并发.html-cefb192f.js" as="script"><link rel="prefetch" href="/assets/Docker.html-0cff330e.js" as="script"><link rel="prefetch" href="/assets/Spring Cloud.html-07f4a147.js" as="script"><link rel="prefetch" href="/assets/ZooKeeper.html-a04866dc.js" as="script"><link rel="prefetch" href="/assets/操作系统.html-c49e7920.js" as="script"><link rel="prefetch" href="/assets/ElasticSearch.html-1f9dae99.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-470b747e.js" as="script"><link rel="prefetch" href="/assets/Redis.html-a7c8dc23.js" as="script"><link rel="prefetch" href="/assets/HTTP.html-41eba7bc.js" as="script"><link rel="prefetch" href="/assets/HTTP2.html-4e92f276.js" as="script"><link rel="prefetch" href="/assets/计算机网络.html-6ab5319a.js" as="script"><link rel="prefetch" href="/assets/面试.html-bfe3c48f.js" as="script"><link rel="prefetch" href="/assets/来看头条.html-1fb1d2ca.js" as="script"><link rel="prefetch" href="/assets/404.html-d06fb4eb.js" as="script"><link rel="prefetch" href="/assets/index.html-a1e4dca0.js" as="script"><link rel="prefetch" href="/assets/index.html-7a957bf4.js" as="script"><link rel="prefetch" href="/assets/index.html-97e27b5e.js" as="script"><link rel="prefetch" href="/assets/index.html-6cfe122b.js" as="script"><link rel="prefetch" href="/assets/index.html-49941d06.js" as="script"><link rel="prefetch" href="/assets/index.html-4ac92770.js" as="script"><link rel="prefetch" href="/assets/index.html-7bde6cfc.js" as="script"><link rel="prefetch" href="/assets/index.html-d9d9e58b.js" as="script"><link rel="prefetch" href="/assets/index.html-25c29132.js" as="script"><link rel="prefetch" href="/assets/index.html-9c5c73dc.js" as="script"><link rel="prefetch" href="/assets/index.html-b8993a0f.js" as="script"><link rel="prefetch" href="/assets/index.html-969b6671.js" as="script"><link rel="prefetch" href="/assets/index.html-961cb4bb.js" as="script"><link rel="prefetch" href="/assets/index.html-77aa8daf.js" as="script"><link rel="prefetch" href="/assets/index.html-1a148cc1.js" as="script"><link rel="prefetch" href="/assets/index.html-84b82bc2.js" as="script"><link rel="prefetch" href="/assets/index.html-37220a3b.js" as="script"><link rel="prefetch" href="/assets/index.html-b45acd55.js" as="script"><link rel="prefetch" href="/assets/index.html-e8617b9a.js" as="script"><link rel="prefetch" href="/assets/index.html-3f6fd7b6.js" as="script"><link rel="prefetch" href="/assets/index.html-3019ec1a.js" as="script"><link rel="prefetch" href="/assets/index.html-b399cee0.js" as="script"><link rel="prefetch" href="/assets/index.html-03ef9901.js" as="script"><link rel="prefetch" href="/assets/index.html-5d2e79c2.js" as="script"><link rel="prefetch" href="/assets/index.html-b34bb68a.js" as="script"><link rel="prefetch" href="/assets/index.html-796102f2.js" as="script"><link rel="prefetch" href="/assets/waline-meta-a31b78ed.js" as="script"><link rel="prefetch" href="/assets/component-b2eb6082.js" as="script"><link rel="prefetch" href="/assets/auto-fa8841cf.js" as="script"><link rel="prefetch" href="/assets/index-ae8c1e74.js" as="script"><link rel="prefetch" href="/assets/flowchart-d65a1d8e.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-e6b10b2d.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-75b11b9d.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-0191f9da.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-a106bb2c.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-ec5549c1.js" as="script"><link rel="prefetch" href="/assets/search.esm-7e6792e2.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/VuePlayground-f19d74a7.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-2450701e.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button type="button" class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a href="/" class="brand"><img class="logo" src="/logo.svg" alt="JavaYoung"><!----><span class="site-name hide-in-pad">JavaYoung</span></a><!--]--><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><!--[--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="主页"><span class="font-icon icon iconfont icon-home" style=""></span>主页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/demo/" class="nav-link" aria-label="项目"><span class="font-icon icon iconfont icon-discover" style=""></span>项目<!----></a></div><div class="nav-item hide-in-mobile"><a href="/guide/" class="nav-link" aria-label="面经指南"><span class="font-icon icon iconfont icon-discover" style=""></span>面经指南<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://github.com/yangluheng" rel="noopener noreferrer" target="_blank" aria-label="关于我" class="nav-link"><span class="font-icon icon iconfont icon-note" style=""></span>关于我<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/yangluheng/yangluheng.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><p class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-note" style=""></span><a href="/page/" class="nav-link title" aria-label="Java基础"><!---->Java基础<!----></a><!----></p><ul class="sidebar-links"><li><!--[--><a href="/page/Java-SE/Java%E5%9F%BA%E7%A1%80.html" class="nav-link sidebar-link sidebar-page" aria-label="Java基础"><!---->Java基础<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">JVM</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/page/JVM/JVM.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM"><!---->JVM<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">多线程和高并发</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/page/duo-xian-cheng-gao-bing-fa/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%92%8C%E9%AB%98%E5%B9%B6%E5%8F%91.html" class="nav-link sidebar-link sidebar-page" aria-label="多线程和高并发"><!---->多线程和高并发<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">Java框架</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/page/Java-frame/Java%E9%AB%98%E7%BA%A7%E6%A1%86%E6%9E%B6.html" class="nav-link sidebar-link sidebar-page" aria-label="框架"><!---->框架<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">数据库</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/page/database/MySQL.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL"><!---->MySQL<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/page/database/Redis.html" class="nav-link sidebar-link sidebar-page" aria-label="Redis"><!---->Redis<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/page/database/ElasticSearch.html" class="nav-link sidebar-link sidebar-page" aria-label="ElasticSearch"><!---->ElasticSearch<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">消息中间件Kafka</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/page/Kafka/Kafka.html" class="nav-link sidebar-link sidebar-page" aria-label="Kafka"><!---->Kafka<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">操作系统</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/page/OS/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.html" class="nav-link sidebar-link sidebar-page" aria-label="操作系统"><!---->操作系统<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">计算机网络</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/page/cs-network/HTTP2.html" class="nav-link sidebar-link sidebar-page" aria-label="HTTP2"><!---->HTTP2<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/page/cs-network/HTTP3.html" class="nav-link sidebar-link sidebar-page" aria-label="HTTP3"><!---->HTTP3<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/page/cs-network/HTTP.html" class="nav-link sidebar-link sidebar-page" aria-label="HTTP协议中为什么广泛使用的还是HTTP1.1？"><!---->HTTP协议中为什么广泛使用的还是HTTP1.1？<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/page/cs-network/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.html" class="nav-link sidebar-link sidebar-page" aria-label="计算机网络"><!---->计算机网络<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">Linux</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/page/Linux/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4.html" class="nav-link sidebar-link sidebar-page" aria-label="Linux常用命令"><!---->Linux常用命令<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">场景问题</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/page/chang-jing/%E5%9C%BA%E6%99%AF%E9%97%AE%E9%A2%98%20.html" class="nav-link sidebar-link sidebar-page" aria-label="场景问题"><!---->场景问题<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">微服务Spring Cloud、分布式</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/page/Spring-Cloud-distribution/Spring%20Cloud.html" class="nav-link sidebar-link sidebar-page" aria-label="Spring Cloud"><!---->Spring Cloud<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/page/Spring-Cloud-distribution/ZooKeeper.html" class="nav-link sidebar-link sidebar-page" aria-label="ZooKeeper"><!---->ZooKeeper<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/page/Spring-Cloud-distribution/Docker.html" class="nav-link sidebar-link sidebar-page" aria-label="Docker"><!---->Docker<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">项目</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/page/project/%E6%9D%A5%E7%9C%8B%E5%A4%B4%E6%9D%A1.html" class="nav-link sidebar-link sidebar-page" aria-label="来看头条"><!---->来看头条<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/page/project/%E9%A1%B9%E7%9B%AE%E4%B8%AD%E5%B8%B8%E7%94%A8%E6%8A%80%E6%9C%AF%E4%B8%80%EF%BC%9AMD5.html" class="nav-link sidebar-link sidebar-page" aria-label="项目中常用技术一：MD5"><!---->项目中常用技术一：MD5<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-note" style=""></span><span class="title">面试</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/page/interview/%E9%9D%A2%E8%AF%95.html" class="nav-link sidebar-link sidebar-page" aria-label="面试"><!---->面试<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->Kafka</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/yangluheng" target="_blank" rel="noopener noreferrer">Young</a></span><span property="author" content="Young"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-05-20T11:00:13.000Z"></span><span class="page-pageview-info" aria-label="访问量🔢" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span class="waline-pageview-count" id="ArtalkPV" data-path="/zh/page/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6Kafka/Kafka.html">...</span></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 10 分钟</span><meta property="timeRequired" content="PT10M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zh/page/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6Kafka/Kafka.html#数据保存的策略" class="router-link-active router-link-exact-active toc-link level3">数据保存的策略</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/page/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6Kafka/Kafka.html#分区策略" class="router-link-active router-link-exact-active toc-link level3">分区策略</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/page/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6Kafka/Kafka.html#kafka如何保证消息不被重复消费" class="router-link-active router-link-exact-active toc-link level3">kafka如何保证消息不被重复消费</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/page/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6Kafka/Kafka.html#如何保证消息的顺序性" class="router-link-active router-link-exact-active toc-link level3">如何保证消息的顺序性?</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h3 id="数据保存的策略" tabindex="-1"><a class="header-anchor" href="#数据保存的策略" aria-hidden="true">#</a> 数据保存的策略</h3><p>kafka 有两种数据保存策略:</p><p>1、按照过期时间保留</p><p>2、按照存储的消息大小保留</p><p>Kafka Broker默认的消息保留策略是：要么保留一定时间，要么保留到消息达到一定大小的字节数。</p><p>当消息达到设置的条件上限时，旧消息就会过期并被删除，所以，在任何时刻，可用消息的总量都不会超过配置参数所指定的大小。</p><p>topic可以配置自己的保留策略，可以将消息保留到不再使用他们为止。</p><p>因为在一个大文件里查找和删除消息是很费时的事，也容易出错，所以，分区被划分为若干个片段。默认情况下，每个片段包含1G或者一周的数据，以较小的那个为准。在broker往leader分区写入消息时，如果达到片段上限，就关闭当前文件，并打开一个新文件。当前正在写入数据的片段叫活跃片段。当所有片段都被写满时，会清除下一个分区片段的数据，如果配置的是7个片段，每天打开一个新片段，就会删除一个最老的片段，循环使用所有片段。</p><p>kafka 同时设置了 7 天和 10G 清除数据，到第五天的时候消息达到了 10G，这个时候 kafka 将如何处理？ 这个时候 kafka 会执行数据清除工作，时间和大小不论那个满足条件，都会清空数据。</p><h3 id="分区策略" tabindex="-1"><a class="header-anchor" href="#分区策略" aria-hidden="true">#</a> 分区策略</h3><h5 id="生产者" tabindex="-1"><a class="header-anchor" href="#生产者" aria-hidden="true">#</a> 生产者：</h5><p><strong>为什么要分区</strong></p><ol><li>多Partition分布式存储，利于集群数据的均衡。</li><li>并发读写，加快读写速度。</li><li>加快数据恢复的速率：当某台机器挂了，每个Topic仅需恢复一部分的数据，多机器并发。</li></ol><p><strong>分区的原则</strong></p><ol><li>指明partition的情况下，使用指定的partition；</li><li>没有指明partition，但是有key的情况下，将key的hash值与topic的partition数进行取余得到partition值；</li><li>既没有指定partition，也没有key的情况下，第一次调用时随机生成一个整数（后面每次调用在这个整数上自增），将这个值与topic可用的partition数取余得到partition值，也就是常说的round-robin算法。</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public int partition(String topic, Object key, byte[] keyBytes, Object value, byte[] valueBytes, Cluster cluster) {
    List&lt;PartitionInfo&gt; partitions = cluster.partitionsForTopic(topic);
    int numPartitions = partitions.size();
    if (keyBytes == null) {
        //key为空时，获取一个自增的计数，然后对分区做取模得到分区编号
        int nextValue = nextValue(topic);
        List&lt;PartitionInfo&gt; availablePartitions = cluster.availablePartitionsForTopic(topic);
        if (availablePartitions.size() &gt; 0) {
            int part = Utils.toPositive(nextValue) % availablePartitions.size();
            return availablePartitions.get(part).partition();
        } else {
            // no partitions are available, give a non-available partition
            return Utils.toPositive(nextValue) % numPartitions;
        }
    } else {
        // hash the keyBytes to choose a partition
        // key不为空时，通过key的hash对分区取模（疑问：为什么这里不像上面那样，使用availablePartitions呢？）
        // 根据《Kafka权威指南》Page45理解：为了保证相同的键，总是能路由到固定的分区，如果使用可用分区，那么因为分区数变化，会导致相同的key，路由到不同分区
        // 所以如果要使用key来映射分区，最好在创建主题的时候就把分区规划好
        return Utils.toPositive(Utils.murmur2(keyBytes)) % numPartitions;
    }
}
 
private int nextValue(String topic) {
    //为每个topic维护了一个AtomicInteger对象，每次获取时+1
    AtomicInteger counter = topicCounterMap.get(topic);
    if (null == counter) {
        counter = new AtomicInteger(ThreadLocalRandom.current().nextInt());
        AtomicInteger currentCounter = topicCounterMap.putIfAbsent(topic, counter);
        if (currentCounter != null) {
            counter = currentCounter;
        }
    }
    return counter.getAndIncrement();
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="消费者" tabindex="-1"><a class="header-anchor" href="#消费者" aria-hidden="true">#</a> 消费者：</h5><p><strong>分区分配策略</strong></p><p>一个consumer group中有多个consumer，一个topic有多个partition，所以必然会涉及到partition的分配问题，即确定哪个partition由哪个consumer来消费。Kafka提供了3种消费者分区分配策略：RangeAssigor、RoundRobinAssignor、StickyAssignor。</p><p>PartitionAssignor接口用于用户定义实现分区分配算法，以实现Consumer之间的分区分配。消费组的成员订阅它们感兴趣的Topic并将这种订阅关系传递给作为订阅组协调者的Broker。协调者选择其中的一个消费者来执行这个消费组的分区分配并将分配结果转发给消费组内所有的消费者。<strong>Kafka默认采用RangeAssignor的分配算法。</strong></p><p><strong>RangeAssignor</strong></p><p>RangeAssignor对每个Topic进行独立的分区分配。对于每一个Topic，首先对分区按照分区ID进行排序，然后订阅这个Topic的消费组的消费者再进行排序，之后尽量均衡的将分区分配给消费者。这里只能是尽量均衡，因为分区数可能无法被消费者数量整除，那么有一些消费者就会多分配到一些分区。分配示意图如下：</p><figure><img src="https://img-blog.csdnimg.cn/img_convert/f4108e1816b3087f38b546372e214958.png" alt="f4108e1816b3087f38b546372e214958.png" tabindex="0" loading="lazy"><figcaption>f4108e1816b3087f38b546372e214958.png</figcaption></figure><p>分区分配的算法如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Override
public Map&lt;String, List&lt;TopicPartition&gt;&gt; assign(Map&lt;String, Integer&gt; partitionsPerTopic,
                                                Map&lt;String, Subscription&gt; subscriptions) {
    Map&lt;String, List&lt;String&gt;&gt; consumersPerTopic = consumersPerTopic(subscriptions);
    Map&lt;String, List&lt;TopicPartition&gt;&gt; assignment = new HashMap&lt;&gt;();
    for (String memberId : subscriptions.keySet())
        assignment.put(memberId, new ArrayList&lt;TopicPartition&gt;());
    //for循环对订阅的多个topic分别进行处理
    for (Map.Entry&lt;String, List&lt;String&gt;&gt; topicEntry : consumersPerTopic.entrySet()) {
        String topic = topicEntry.getKey();
        List&lt;String&gt; consumersForTopic = topicEntry.getValue();
 
        Integer numPartitionsForTopic = partitionsPerTopic.get(topic);
        if (numPartitionsForTopic == null)
            continue;
        //对消费者进行排序
        Collections.sort(consumersForTopic);
        //计算平均每个消费者分配的分区数
        int numPartitionsPerConsumer = numPartitionsForTopic / consumersForTopic.size();
        //计算平均分配后多出的分区数
        int consumersWithExtraPartition = numPartitionsForTopic % consumersForTopic.size();
 
        List&lt;TopicPartition&gt; partitions = AbstractPartitionAssignor.partitions(topic, numPartitionsForTopic);
        for (int i = 0, n = consumersForTopic.size(); i &lt; n; i++) {
            //计算第i个消费者，分配分区的起始位置
            int start = numPartitionsPerConsumer * i + Math.min(i, consumersWithExtraPartition);
            //计算第i个消费者，分配到的分区数量
            int length = numPartitionsPerConsumer + (i + 1 &gt; consumersWithExtraPartition ? 0 : 1);
            assignment.get(consumersForTopic.get(i)).addAll(partitions.subList(start, start + length));
        }
    }
    return assignment;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这种分配方式明显的一个问题是随着消费者订阅的Topic的数量的增加，不均衡的问题会越来越严重，比如上图中4个分区3个消费者的场景，C0会多分配一个分区。如果此时再订阅一个分区数为4的Topic，那么C0又会比C1、C2多分配一个分区，这样C0总共就比C1、C2多分配两个分区了，而且随着Topic的增加，这个情况会越来越严重。分配结果：</p><figure><img src="https://img-blog.csdnimg.cn/img_convert/eff9adb5a086691e56b5d68bec68ffcf.png" alt="eff9adb5a086691e56b5d68bec68ffcf.png" tabindex="0" loading="lazy"><figcaption>eff9adb5a086691e56b5d68bec68ffcf.png</figcaption></figure><p>订阅2个Topic，每个Topic4个分区，共3个Consumer</p><ul><li><strong>C0：</strong>[T0P0，T0P1，T1P0，T1P1]</li><li><strong>C1：</strong>[T0P2，T1P2]</li><li><strong>C2：</strong>[T0P3，T1P3]</li></ul><p><strong>RoundRobinAssignor</strong></p><p>RoundRobinAssignor的分配策略是将消费组内订阅的所有Topic的分区及所有消费者进行排序后尽量均衡的分配（RangeAssignor是针对单个Topic的分区进行排序分配的）。如果消费组内，消费者订阅的Topic列表是相同的（每个消费者都订阅了相同的Topic），那么分配结果是尽量均衡的（消费者之间分配到的分区数的差值不会超过1）。如果订阅的Topic列表是不同的，那么分配结果是不保证“尽量均衡”的，因为某些消费者不参与一些Topic的分配。</p><figure><img src="https://img-blog.csdnimg.cn/img_convert/51b27d00cf50d9aca86e0934ab42a565.png" alt="51b27d00cf50d9aca86e0934ab42a565.png" tabindex="0" loading="lazy"><figcaption>51b27d00cf50d9aca86e0934ab42a565.png</figcaption></figure><p>以上两个topic的情况，相比于之前RangeAssignor的分配策略，可以使分区分配的更均衡。不过考虑这种情况，假设有三个消费者分别为C0、C1、C2，有3个Topic T0、T1、T2，分别拥有1、2、3个分区，并且C0订阅T0，C1订阅T0和T1，C2订阅T0、T1、T2，那么RoundRobinAssignor的分配结果如下：</p><figure><img src="https://img-blog.csdnimg.cn/img_convert/4e161a06a0afcae8d2c06603d676de4e.png" alt="4e161a06a0afcae8d2c06603d676de4e.png" tabindex="0" loading="lazy"><figcaption>4e161a06a0afcae8d2c06603d676de4e.png</figcaption></figure><p>看上去分配已经尽量的保证均衡了，不过可以发现C2承担了4个分区的消费而C1订阅了T1，是不是把T1P1交给C1消费能更加的均衡呢？</p><p><strong>StickyAssignor</strong></p><p>StickyAssignor分区分配算法，目的是在执行一次新的分配时，能在上一次分配的结果的基础上，尽量少的调整分区分配的变动，节省因分区分配变化带来的开销。Sticky是“粘性的”，可以理解为分配结果是带“粘性的”——每一次分配变更相对上一次分配做最少的变动。其目标有两点：</p><ul><li>分区的分配尽量的均衡。</li><li>每一次重分配的结果尽量与上一次分配结果保持一致。</li></ul><p>当这两个目标发生冲突时，优先保证第一个目标。第一个目标是每个分配算法都尽量尝试去完成的，而第二个目标才真正体现出StickyAssignor特性的。</p><p>StickyAssignor算法比较复杂，下面举例来说明分配的效果（对比RoundRobinAssignor），前提条件：</p><ul><li>有4个Topic：T0、T1、T2、T3，每个Topic有2个分区。</li><li>有3个Consumer：C0、C1、C2，所有Consumer都订阅了这4个分区。</li></ul><figure><img src="https://img-blog.csdnimg.cn/img_convert/eb5597ed0b81b03c762e54ff3f909492.png" alt="eb5597ed0b81b03c762e54ff3f909492.png" tabindex="0" loading="lazy"><figcaption>eb5597ed0b81b03c762e54ff3f909492.png</figcaption></figure><p>上面红色的箭头代表的是有变动的分区分配，可以看出，StickyAssignor的分配策略，变动较小。</p><p>参考：<a href="https://blog.csdn.net/easylife206/article/details/124580641?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-4-124580641-blog-124349832.235%5Ev28%5Epc_relevant_t0_download&amp;spm=1001.2101.3001.4242.3&amp;utm_relevant_index=7" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/easylife206/article/details/124580641?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-4-124580641-blog-124349832.235^v28^pc_relevant_t0_download&amp;spm=1001.2101.3001.4242.3&amp;utm_relevant_index=7<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="kafka如何保证消息不被重复消费" tabindex="-1"><a class="header-anchor" href="#kafka如何保证消息不被重复消费" aria-hidden="true">#</a> kafka如何保证消息不被重复消费</h3><h4 id="原因" tabindex="-1"><a class="header-anchor" href="#原因" aria-hidden="true">#</a> 原因</h4><p>（1）kafka有个offset的概念，当每个消息被写进去后，都有一个offset，代表他的序号，然后consumer消费该数据之后，隔一段时间，会把自己消费过的消息的offset提交一下，代表我已经消费过了。下次我要是重启，就会继续从上次消费到的offset来继续消费。但是当我们直接kill进程了，再重启。这会导致consumer有些消息处理了，但是没来得及提交offset。等重启之后，少数消息就会再次消费一次 （2）在Kafka中有一个Partition Balance机制，就是把多个Partition均衡的分配给多个消费者。消费端会从分配到的Partition里面去消费消息，如果消费者在默认的5分钟内没有处理完这一批消息。就会触发Kafka的Rebalance机制，从而导致offset自动提交失败。而Rebalance之后，消费者还是会从之前没提交的offset位置开始消费，从而导致消息重复消费。</p><h4 id="解决方案" tabindex="-1"><a class="header-anchor" href="#解决方案" aria-hidden="true">#</a> 解决方案</h4><ul><li><p><strong>开启kafka本身存在的幂等性：</strong></p><figure><img src="https://img-blog.csdnimg.cn/afb50c35d4dd4b14bd8f30929a494228.png" alt="在这里插入图片描述" tabindex="0" loading="lazy"><figcaption>在这里插入图片描述</figcaption></figure><p>注： 添加唯一ID，类似于数据库的主键，用于唯一标记一个消息。 ProducerID：#在每个新的Producer初始化时，会被分配一个唯一的PID SequenceNumber：#对于每个PID发送数据的每个Topic都对应一个从0开始单调递增的SN值。</p></li><li><p><strong>将获取的唯一id存表，（利用mySQl的唯一键约束，或者redis天然的set结构）</strong></p></li></ul><p>参考：<a href="https://blog.csdn.net/m0_51167384/article/details/128106266?spm=1001.2101.3001.6650.7&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-7-128106266-blog-76435385.235%5Ev28%5Epc_relevant_t0_download&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-7-128106266-blog-76435385.235%5Ev28%5Epc_relevant_t0_download&amp;utm_relevant_index=8&amp;ydreferer=aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTA2Mjc4NDAvYXJ0aWNsZS9kZXRhaWxzLzc2NDM1Mzg1P3NwbT0xMDAxLjIxMDEuMzAwMS42NjUwLjEmdXRtX21lZGl1bT1kaXN0cmlidXRlLnBjX3JlbGV2YW50Lm5vbmUtdGFzay1ibG9nLTIlN0VkZWZhdWx0JTdFQ1RSTElTVCU3RVJhdGUtMS03NjQzNTM4NS1ibG9nLTExNzQxOTA1OC4yMzUlNUV2MjglNUVwY19yZWxldmFudF90MF9kb3dubG9hZCZkZXB0aF8xLXV0bV9zb3VyY2U9ZGlzdHJpYnV0ZS5wY19yZWxldmFudC5ub25lLXRhc2stYmxvZy0yJTdFZGVmYXVsdCU3RUNUUkxJU1QlN0VSYXRlLTEtNzY0MzUzODUtYmxvZy0xMTc0MTkwNTguMjM1JTVFdjI4JTVFcGNfcmVsZXZhbnRfdDBfZG93bmxvYWQmdXRtX3JlbGV2YW50X2luZGV4PTI%3D" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/m0_51167384/article/details/128106266?spm=1001.2101.3001.6650.7&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-7-128106266-blog-76435385.235^v28^pc_relevant_t0_download&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-7-128106266-blog-76435385.235^v28^pc_relevant_t0_download&amp;utm_relevant_index=8&amp;ydreferer=aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTA2Mjc4NDAvYXJ0aWNsZS9kZXRhaWxzLzc2NDM1Mzg1P3NwbT0xMDAxLjIxMDEuMzAwMS42NjUwLjEmdXRtX21lZGl1bT1kaXN0cmlidXRlLnBjX3JlbGV2YW50Lm5vbmUtdGFzay1ibG9nLTIlN0VkZWZhdWx0JTdFQ1RSTElTVCU3RVJhdGUtMS03NjQzNTM4NS1ibG9nLTExNzQxOTA1OC4yMzUlNUV2MjglNUVwY19yZWxldmFudF90MF9kb3dubG9hZCZkZXB0aF8xLXV0bV9zb3VyY2U9ZGlzdHJpYnV0ZS5wY19yZWxldmFudC5ub25lLXRhc2stYmxvZy0yJTdFZGVmYXVsdCU3RUNUUkxJU1QlN0VSYXRlLTEtNzY0MzUzODUtYmxvZy0xMTc0MTkwNTguMjM1JTVFdjI4JTVFcGNfcmVsZXZhbnRfdDBfZG93bmxvYWQmdXRtX3JlbGV2YW50X2luZGV4PTI%3D<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="如何保证消息的顺序性" tabindex="-1"><a class="header-anchor" href="#如何保证消息的顺序性" aria-hidden="true">#</a> 如何保证消息的顺序性?</h3><h4 id="为什么要保证顺序" tabindex="-1"><a class="header-anchor" href="#为什么要保证顺序" aria-hidden="true">#</a> 为什么要保证顺序？</h4><p>消息队列中的若干消息如果是对同一个数据进行操作, 这些操作具有前后关系, 必须要按前后的顺序执行, 否则就会造成数据异常.</p><h4 id="出现顺序错乱的场景" tabindex="-1"><a class="header-anchor" href="#出现顺序错乱的场景" aria-hidden="true">#</a> 出现顺序错乱的场景：</h4><pre><code>第一种情况:
一个queue, 有多个consumer去消费, 这样就会造成顺序的错误, consumer从MQ里面读取数据是有序的, 但是每个consumer的执行时间是不固定的, 无法保证先读到消息的consumer一定先完成操作, 这样就会出现消息并没有按照顺序执行, 造成数据顺序错误。
</code></pre><figure><img src="https://img-blog.csdnimg.cn/cfe17769c1c949a4b6eced9fe3d68491.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Y-v54ix6L-35Lq6,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>第二种情况:

一个queue对应一个consumer, 但是consumer里面进行了多线程消费, 这样也会造成消息消费顺序错误。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://img-blog.csdnimg.cn/3fed5f0626084f83ae5aea89963d5fc6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Y-v54ix6L-35Lq6,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h4 id="如何保证消息的消费顺序" tabindex="-1"><a class="header-anchor" href="#如何保证消息的消费顺序" aria-hidden="true">#</a> 如何保证消息的消费顺序？</h4><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>第一种方案:

拆分多个queue, 每一个queue一个consumer, 就是多一些queue而已, 确实是麻烦点; 这样也会造成吞吐量下降, 可以在消费者内部采用多线程的方式去消费。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://img-blog.csdnimg.cn/f1e9445d6c5d411b9b9b385c70797fcc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Y-v54ix6L-35Lq6,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>第二种方案:

就是一个queue对应一个consumer, 然后这个consumer内部用内存队列做排队, 然后分发给底层不同的worker来处理。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://img-blog.csdnimg.cn/227a2d3b375e47e0aa171bd184ba7af1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5Y-v54ix6L-35Lq6,size_20,color_FFFFFF,t_70,g_se,x_16" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>参考：<a href="https://blog.csdn.net/qq_44901983/article/details/123416498" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/qq_44901983/article/details/123416498<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/yangluheng/yangluheng.github.io/edit/main/zh/page/消息中间件Kafka/Kafka.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: ylh310508863@outlook.com">Hans Young</span><!--]--><!--]--></div></div></footer><!----><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">© 2023-present 鲁ICP备19028049号</div><div class="copyright">Copyright © 2023 Young</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-e5b0ad63.js" defer></script>
  </body>
</html>
